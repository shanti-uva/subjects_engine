<%= stylesheet_link_tag('subjects_engine/related') %>
<% feature_label = fname_labels(@feature).s %>
<div id='myTabs'>
  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#relation_tree" aria-controls="profile" role="tab" data-toggle="tab">Relationships</a></li>
    <li role="presentation"><a id="summary-tab-link" href="#relation_details" aria-controls="home" role="tab" data-toggle="tab">Summary</a></li>
  </ul>
  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="relation_tree">
      <section class="panel panel-content">
        <div class="panel-body">
          <p>
          <strong><%= feature_label %></strong> has <strong class="relatedCountContainer"></strong> subordinate subjects. You can browse those subordinate subjects as well as its superordinate categories with the tree below. See the summary tab if you instead prefer to view only  its immediately subordinate subjects grouped together in useful ways, as well as   subjects non-hierarchically related to it.
          </p>
            <div id='relation_tree_container'></div>
        </div> <!-- END panel-body -->
      </section> <!-- END panel -->
  </div>
    <div role="tabpanel" class="tab-pane" id="relation_details">
      <section class="panel panel-content">
        <div class="panel-body">
          <p>
          <strong><%= feature_label %></strong> has <strong class="relatedCountContainer"><%#= relation_counts %></strong> other subjects directly related to it, which are presented here. See the relationships tab if you instead prefer to browse  all subordinate and superordinate categories for <%= feature_label %>.
          </p>
          <div class='tab-content-loading' style="display:none">Loading...</div>
          <div class="collapsible_btns_container" style="display:none" >
            <h5> <span class="collapsible_all_btn collapsible_expand_all">Expand all</span> / <span class="collapsible_all_btn collapsible_collapse_all">Collapse all</span> </h5>
          </div>
        <div class="subjects-in-subjects kmaps-list-columns related-features has-ajax-pagination has-hash-feature-links"> </div> <!-- END  subjects-in-subjects -->
        <div class="collapsible_btns_container" style="display:none">
          <h5> <span class="collapsible_all_btn collapsible_expand_all">Expand all</span> / <span class="collapsible_all_btn collapsible_collapse_all">Collapse all</span> </h5>
        </div>
        <br />
        </div> <!-- END panel-body -->
      </section> <!-- END panel -->
    </div> <!-- END tabpanel -->
  </div> <!-- Tab Content -->
</div> <!-- myTabs end -->

<%= javascript_include_tag 'kmaps_engine/kmaps_relations_tree' %>
<%= javascript_on_load do %>
  var relatedSolrUtils = kmapsSolrUtils.init({
    termIndex: "<%= Feature.config.url %>",
    assetIndex: "<%= Flare.config.asset_url %>",
    featureId:  "<%= Feature.uid_prefix %>-<%= @feature.fid %>",
    domain: "<%= Feature.uid_prefix %>",
    perspective: "<%= current_perspective.code %>",
  });

  //Related Counts on Solr
  relatedSolrUtils.getDirectDescendantCount().then(function(count){
      $(".relatedCountContainer").each(function(){
          $(this).html(count);
      });
  });
  var summaryLoaded = false;
  var collapsibleApplied = false;
  var popupsSet = false;
  var columnizedApplied = false;
  $('#summary-tab-link[data-toggle="tab"]').on('shown.bs.tab', function (e) {
  //Code for Summary
  if(!summaryLoaded){
    $("#relation_details .tab-content-loading").show();
    relatedSolrUtils.getSubjectsSummaryElements().then(function(result){
      var feature_label = $('<%= feature_label %>')[0].innerText;
      var feature_path = "<%= features_path %>/%%ID%%";
      relatedSolrUtils.addSubjectsSummaryItems(feature_label,feature_path,'parent',result);
      relatedSolrUtils.addSubjectsSummaryItems(feature_label,feature_path,'child',result);
      //relatedSolrUtils.addSubjectsSummaryItems(feature_label,feature_path,'other',result);

      // Functionality for columnizer
      // dontsplit = don't break these headers
      $('.subjects-in-subjects').find('.column > h6, .column > ul > li, .column ul').addClass("dontsplit");
      // dontend = don't end column with headers
      $('.subjects-in-subjects').find('.column > h6, .column > ul > li').addClass("dontend");
      $('.subjects-in-subjects').find('.feature-block').addClass("dontsplit");
      if(!columnizedApplied){
        $('.kmaps-list-columns:not(.places-in-subjects):not(.already_columnized)').addClass('already_columnized').columnize({
          width: 330,
          lastNeverTallest : true,
          buildOnce: true,
        });
        columnizedApplied = true;
      }
      if(!collapsibleApplied){
        $('.collapsibleList').kmapsCollapsibleList();
        collapsibleApplied = true;
      }
      if(!popupsSet){
        jQuery('#relation_details .popover-kmaps').kmapsPopup({
          featuresPath: "<%= features_path %>/%%ID%%",
          domain: "<%= Feature.uid_prefix %>",
          featureId:  "",
          mandalaURL: "https://mandala.shanti.virginia.edu/%%APP%%/%%ID%%/%%REL%%/nojs",
          solrUtils: relatedSolrUtils
        });
        popupsSet = true;
       }
      $("#relation_details .tab-content-loading").hide();
      $("#relation_details .collapsible_btns_container").show();
      summaryLoaded = true;
    });
  }
  }); // END - Summary Tab on show action
  $(".collapsible_expand_all").on("click",function(e){
    $("ul.collapsibleList li.collapsibleListClosed").trigger("click");
  });
  $(".collapsible_collapse_all").on("click",function(e){
    $("ul.collapsibleList li.collapsibleListOpen").trigger("click");
  });
  $(".collapsible_expand_all").on("click",function(e){
   $(".collapsible_collapse_all").removeClass("collapsible_all_btn_selected");
    if (!$(".collapsible_expand_all").hasClass("collapsible_all_btn_selected")) {
     $(".collapsible_expand_all").addClass("collapsible_all_btn_selected");
    }
    $('.collapsibleList').kmapsCollapsibleList('expandAll');
  });
  $(".collapsible_collapse_all").on("click",function(e){
   $(".collapsible_expand_all").removeClass("collapsible_all_btn_selected");
    if (!$(".collapsible_collapse_all").hasClass("collapsible_all_btn_selected")) {
     $(".collapsible_collapse_all").addClass("collapsible_all_btn_selected");
    }
    $('.collapsibleList').kmapsCollapsibleList('collapseAll');
  });

  $("#relation_tree_container").kmapsRelationsTree({
    featureId: "<%= @feature.fid %>",
    termIndex: "<%= Feature.config.url %>",
    assetIndex: "<%= Flare.config.asset_url %>",
    perspective: "<%= current_perspective.code %>",
    tree: "<%= Feature.uid_prefix %>", //subjects
    domain: "<%= Feature.uid_prefix %>", //subjects
    seedTree: {
      descendants: true,
      directAncestors: false,
    },
    displayPopup: true
  });
<% end %>
<%= javascript_include_tag('collapsible_list/jquery.kmapsCollapsibleList') %>
